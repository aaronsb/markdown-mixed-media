# Markdown Mixed Media (MMM) Project

## Overview
This project provides enhanced markdown rendering for terminal, PDF, and ODT outputs with support for images, Mermaid diagrams, and syntax highlighting.

## Rendering Methods

### 1. Direct Render (`npm run dev` or `npm run start`)
**Recommended for terminal viewing with images**
- Renders markdown directly to terminal with full image support
- Uses Sixel/iTerm2/Kitty protocols for inline images
- Supports Mermaid diagrams rendered as images
- Supports embedded SVG rendering
- Enhanced syntax highlighting with semantic coloring
- Best terminal experience for viewing documents with mixed media

### 2. Simple Render (`npm run dev:simple`)
**For basic terminal viewing without images**
- Plain text rendering without image support
- Images shown as placeholder text `[Image: description]`
- Lightweight and compatible with all terminals
- Good for quick text-only viewing or terminals without graphics support

## Syntax Highlighting Features

The direct renderer includes enhanced syntax highlighting with:

### Visual Elements
- **Bold** - Keywords, built-in types, class names
- *Italic* - Function/method calls, parameters
- <u>Underline</u> - Links, URLs (where applicable)
- Colors - Different semantic elements (strings, numbers, operators, comments)

### Supported Languages
- JavaScript/TypeScript
- Python
- Go
- Rust
- Java
- C/C++
- Ruby
- Bash/Shell
- SQL
- JSON
- YAML
- Markdown

### Code Element Styling
- **Keywords**: Bold cyan (if, class, function, etc.)
- **Types/Classes**: Bold yellow (String, Array, etc.)
- **Functions**: Italic bright white (method calls)
- **Variables**: Regular or italic (context-dependent)
- **Strings**: Green
- **Numbers**: Magenta
- **Comments**: Dim gray
- **Operators**: Bright blue
- **Decorators/Annotations**: Bright magenta

## Configuration

Configuration file location: `~/.config/mmm/config.json`

Key settings for terminal rendering:
- `terminal.fallbackColumns`: Default terminal width
- `tables.wordWrap`: Enable table text wrapping
- `tables.widthPercent`: Table width as percentage of terminal
- `images.widthPercent`: Image width as percentage of terminal
- `images.alignment`: Image alignment (left/center/right)

## Usage Examples

```bash
# Render with images (recommended)
npm run dev:direct document.md

# Render from piped input
cat document.md | npm run start
echo "# Hello World" | npm run start

# Simple text-only rendering
npm run dev:simple document.md

# Build and run production version
npm run build
npm run start document.md

# Export to PDF
npm run start document.md --pdf output.pdf

# Export to ODT
npm run start document.md --odt output.odt
```

## Development Notes

- The project uses TypeScript and compiles to JavaScript
- Main entry points:
  - `src/index-direct.tsx` - Direct renderer (default)
  - `src/index-simple.tsx` - Simple text renderer
- Key libraries:
  - Syntax highlighter: `src/lib/terminal-syntax-highlighter.ts`
  - Image rendering: `src/lib/image.ts`
  - Mermaid support: `src/lib/mermaid.ts`
  - SVG support: `src/lib/svg.ts`
  - PDF generation: `src/lib/pdf-renderer.ts`
  - ODT generation: `src/lib/odt-renderer.ts`

## Release & AUR Management

### Version Information
- Version info is auto-generated during build from git tags and commit hash
- Displayed in `mmm --help` output
- Generated by `scripts/generate-version.js`

### Updating AUR Package

The project includes an automated script for updating the AUR package:

```bash
# Auto-detect version from latest git tag
npm run aur:update

# Specify version explicitly
./scripts/update-aur.sh -v 1.0.2

# Auto-push to AUR
./scripts/update-aur.sh -v 1.0.2 -p

# Show help
./scripts/update-aur.sh --help
```

The script will:
1. Download the release tarball from GitHub
2. Calculate SHA256 checksum
3. Update PKGBUILD in both project and AUR repo
4. Generate .SRCINFO
5. Commit changes
6. Optionally push to AUR

**Prerequisites:**
- AUR repository cloned at `~/Projects/aur/mmm` (or set `AUR_REPO_DIR`)
- SSH access to AUR configured
- `makepkg` installed (from base-devel)

### Release Workflow

The release process is fully automated with two scripts that work together. This workflow ensures:
- **Immutable artifacts**: GitHub creates the tarball once, checksum never changes
- **Single source of truth**: AUR pulls from GitHub releases
- **Automated documentation**: Release notes and commit messages generated from git history
- **Error prevention**: Scripts validate everything exists before proceeding
- **Zero manual work**: Checksums and version info handled automatically

#### Quick Release (Fully Automated)

For a complete release in 2 commands:

```bash
# Step 1: Create GitHub Release (auto-push)
npm run release:create -- -v 1.0.x -p

# Step 2: Update AUR (auto-push)
npm run aur:update -- -p
```

Done! The package is now available on both GitHub and AUR.

#### Detailed Release Steps

**1. Make changes and commit** to main branch
   ```bash
   git add .
   git commit -m "feat: your new feature"
   git push origin main
   ```

**2. Create GitHub Release** (creates immutable artifact with checksum)
   ```bash
   # Interactive mode with auto-generated release notes
   npm run release:create -- -v 1.0.x

   # Automated mode (no prompts)
   npm run release:create -- -v 1.0.x -p

   # Or use the script directly
   ./scripts/create-release.sh -v 1.0.x -p
   ```

   This script will:
   - Parse git commits and categorize by type (feat/fix/docs/chore)
   - Generate formatted release notes
   - Create and push git tag
   - Create GitHub Release with notes
   - Download tarball and calculate SHA256 checksum
   - Display checksum in release notes

**3. Update AUR** (pulls from GitHub release artifact)
   ```bash
   # Auto-detect version from latest tag, interactive mode
   npm run aur:update

   # Specify version and auto-push
   npm run aur:update -- -v 1.0.x -p

   # Or use the script directly
   ./scripts/update-aur.sh -v 1.0.x -p
   ```

   This script will:
   - Clone AUR repo if it doesn't exist (one-time setup)
   - Verify GitHub release exists
   - Download tarball from GitHub release
   - Calculate SHA256 checksum (always matches GitHub's)
   - Update PKGBUILD with new version and checksum
   - Generate .SRCINFO
   - Generate commit message from git history
   - Commit changes
   - Optionally push to AUR

#### Script Options

Both scripts support:
- `-v VERSION` or `--version VERSION` - Specify version to release/update
- `-p` or `--push` - Auto-push without prompting
- `-h` or `--help` - Show detailed help

#### Environment Variables

- `AUR_REPO_DIR` - Path to AUR repository (default: `~/Projects/aur/mmm`)

#### Example: Complete Release Session

```bash
# Make your changes
git add .
git commit -m "feat: add new markdown extension support"
git push origin main

# Create release (fully automated)
npm run release:create -- -v 1.0.3 -p

# Update AUR (fully automated)
npm run aur:update -- -p

# Verify
yay -Syu mmm  # Users can now get v1.0.3
```

#### Why This Workflow Works

1. **GitHub creates immutable artifacts** - When you push a tag, GitHub generates a tarball that never changes
2. **Checksums are stable** - The tarball checksum is calculated once and remains constant
3. **AUR pulls from GitHub** - PKGBUILD points to GitHub's archive URL
4. **No manual checksum management** - Scripts handle all checksum calculation automatically
5. **Automated documentation** - Release notes and commit messages generated from git history
6. **Safe automation** - Scripts validate releases exist and checksums match before proceeding